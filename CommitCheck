@Library('pipeline-mylib') _

node {
    docker.image('mingc/android-build-box').inside('-v /opt/.gradle:/root/.gradle') {
        stage('codeDownload') {
            checkout(
                    [$class                           : 'GitSCM',
                     branches                         : [[name: "*/${env.BRANCH_NAME}"]],
                     doGenerateSubmoduleConfigurations: false,
                     extensions                       : [],
                     submoduleCfg                     : [],
                     userRemoteConfigs                : [[credentialsId: 'github_token',
                                                          url          : 'https://github.com/dearbear-zhang/AndroidCode.git']]
                    ]
            )
        }
        stage('build') {
            sh './gradlew build'
        }
        stage('static check with findbugs') {
            sh './gradlew findbugs'
        }
        stage('static check with lint') {
            sh './gradlew lint'
        }
        stage('archiveArtifacts') {
            archiveArtifacts artifacts: 'app/build/outputs/apk/**/*.apk', followSymlinks: false
        }
        stage('junit') {
            sh './gradlew test'
            echo 'junit report'    
            publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: false, reportDir: '**/build/reports/tests/**/index.html', reportFiles: 'index.html', reportName: 'HTML Report', reportTitles: ''])
        }
        stage("clean") {
            sh './gradlew clean'
        }
    }
}